# Acme Auth Service Integration Guide

This document explains how the tickets service integrates with **acme-auth-service** for authentication and authorization.

## Overview

The tickets service validates JWT tokens issued by acme-auth-service. These tokens contain tenant information, user roles, and permission scopes that enforce multi-tenant isolation and role-based access control.

## JWT Token Structure

Tokens issued by acme-auth-service have the following structure:

```json
{
  "sub": "user@example.com",
  "tenant_id": "550e8400-e29b-41d4-a716-446655440000",
  "roles": ["ROLE_USER"],
  "scopes": ["tickets:read:own", "tickets:write:own"],
  "iat": 1704067200,
  "exp": 1704153600
}
```

### Token Claims

| Claim | Type | Description |
|-------|------|-------------|
| `sub` | string | User's email address |
| `tenant_id` | string | UUID of the user's tenant (for isolation) |
| `roles` | string[] | Array of roles: `ROLE_USER`, `ROLE_AGENT`, `ROLE_ADMIN` |
| `scopes` | string[] | Auto-generated permission scopes based on roles |
| `iat` | number | Unix timestamp when token was issued |
| `exp` | number | Unix timestamp when token expires (24h default) |

## Role Mapping

The tickets service maps acme-auth roles to internal Prisma `UserRole` enum:

| acme-auth Role | Tickets Service Role | Description |
|----------------|----------------------|-------------|
| `ROLE_USER` | `USER` | Regular user, can only access own tickets |
| `ROLE_AGENT` | `AGENT` | Support agent, can access all tickets in tenant |
| `ROLE_ADMIN` | `ADMIN` | Administrator, full access including deletions |

## Permission Scopes

Scopes are auto-generated by acme-auth-service based on user roles:

### ROLE_USER Scopes
- `tickets:read:own` - Read tickets created by the user
- `tickets:write:own` - Create and modify own tickets

### ROLE_AGENT Scopes
- `tickets:read:own` - Read own tickets
- `tickets:write:own` - Create and modify own tickets
- `tickets:read:any` - Read all tickets in tenant
- `tickets:read:assigned` - Read assigned tickets
- `tickets:write:assigned` - Modify assigned tickets

### ROLE_ADMIN Scopes
- `tickets:read:any` - Read all tickets in tenant
- `tickets:write:any` - Modify any ticket in tenant
- `tickets:delete:any` - Delete tickets
- `users:read:any` - Read user information
- `users:write:any` - Manage users

## Access Control Implementation

### Authentication Flow

1. **Token Extraction**: Extract JWT from `Authorization: Bearer <token>` header
2. **Token Verification**: Verify signature using shared `JWT_SECRET`
3. **Claims Extraction**: Extract `sub`, `tenant_id`, `roles`, and `scopes`
4. **Database Lookup**: Query user by email to get `userId`
5. **Tenant Verification**: Ensure `tenant_id` from token matches user's `tenantId` in database
6. **Role Mapping**: Map token roles to Prisma `UserRole` enum
7. **Request Augmentation**: Attach user info to `req.user` for controllers

### Authorization Enforcement

#### Service Layer (ticket.service.ts)

The service layer enforces role-based access control:

**GET /tickets** (List)
- **USER**: Only sees tickets they created (`createdById = userId`)
- **AGENT**: Sees all tickets in their tenant
- **ADMIN**: Sees all tickets in their tenant

**GET /tickets/:id** (Single)
- **USER**: Can only access tickets they created
- **AGENT**: Can access any ticket in tenant
- **ADMIN**: Can access any ticket in tenant

**PUT /tickets/:id** (Update)
- **USER**: Can only modify tickets they created
- **AGENT**: Can modify any ticket in tenant
- **ADMIN**: Can modify any ticket in tenant

**DELETE /tickets/:id** (Delete)
- **USER**: Cannot delete tickets
- **AGENT**: Cannot delete tickets
- **ADMIN**: Can delete any ticket in tenant

#### Middleware (auth.ts)

The middleware provides helper functions:

- `authenticate` - Validates JWT and populates `req.user`
- `authorize(...roles)` - Ensures user has one of the specified roles
- `requireScope(...scopes)` - Ensures user has one of the specified scopes
- `checkTenantAccess` - Verifies tenant isolation
- `canAccessTicket(ticket, user)` - Checks if user can read a ticket
- `canModifyTicket(ticket, user)` - Checks if user can modify a ticket

## Configuration

### Environment Variables

**CRITICAL**: The `JWT_SECRET` must be identical in both services for token validation to work.

```bash
# .env file
JWT_SECRET=your-shared-secret-minimum-32-characters

# Generate a strong secret:
openssl rand -base64 32
# OR
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

**Important Configuration Files:**
- `.env.example` - Template with JWT_SECRET documentation
- `src/config/env.ts` - Environment variable loading with comments

## Error Responses

All authentication/authorization errors follow the acme-contracts `ErrorResponse` format:

### 401 Unauthorized

**Missing Token:**
```json
{
  "code": "UNAUTHORIZED",
  "message": "Authentication required",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

**Invalid Token:**
```json
{
  "code": "UNAUTHORIZED",
  "message": "Invalid token",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

**Expired Token:**
```json
{
  "code": "UNAUTHORIZED",
  "message": "Token expired",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

### 403 Forbidden

**Insufficient Permissions:**
```json
{
  "code": "FORBIDDEN",
  "message": "Insufficient permissions",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

**Access Denied:**
```json
{
  "code": "FORBIDDEN",
  "message": "Access denied to this ticket",
  "timestamp": "2024-01-01T12:00:00.000Z"
}
```

## Testing

### Manual Testing with curl

1. **Get a token from acme-auth-service:**

```bash
# Register a user
curl -X POST http://localhost:8080/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!",
    "name": "Test User"
  }'

# Login to get token
TOKEN=$(curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "SecurePass123!"
  }' | jq -r '.accessToken')
```

2. **Use token with tickets service:**

```bash
# Create a ticket
curl -X POST http://localhost:3000/api/v1/tickets \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Ticket",
    "description": "Testing authentication",
    "priority": "medium"
  }'

# List tickets
curl -X GET http://localhost:3000/api/v1/tickets \
  -H "Authorization: Bearer $TOKEN"

# Get current user
curl -X GET http://localhost:3000/api/v1/auth/me \
  -H "Authorization: Bearer $TOKEN"
```

### Verify Token Claims

You can decode the JWT to inspect claims at [jwt.io](https://jwt.io) or using:

```bash
echo $TOKEN | cut -d. -f2 | base64 -d | jq
```

Expected output:
```json
{
  "sub": "user@example.com",
  "tenant_id": "00000000-0000-0000-0000-000000000001",
  "roles": ["ROLE_USER"],
  "scopes": ["tickets:read:own", "tickets:write:own"],
  "iat": 1704067200,
  "exp": 1704153600
}
```

## API Documentation

Full API documentation with JWT authentication details is available at:

```
http://localhost:3000/api-docs
```

The Swagger UI includes:
- JWT authentication scheme documentation
- Role and scope descriptions
- Error response schemas
- Example requests with Bearer tokens

## Related Documentation

- [acme-auth-service Repository](https://github.com/RobertLukenbillIV/acme-auth-service)
- [acme-auth-service Integration Guide](https://github.com/RobertLukenbillIV/acme-auth-service/blob/main/INTEGRATION.md)
- [acme-contracts Repository](https://github.com/RobertLukenbillIV/acme-contracts)

## Troubleshooting

### Common Issues

**Issue: "Invalid token"**
- **Cause**: JWT_SECRET mismatch between services
- **Solution**: Verify both services use the same JWT_SECRET value

**Issue: "User not found"**
- **Cause**: User exists in auth service but not in tickets service database
- **Solution**: Ensure user is created in tickets service database (sync mechanism needed)

**Issue: "Tenant mismatch"**
- **Cause**: Token tenant_id doesn't match user's tenantId in database
- **Solution**: Verify tenant consistency across services

**Issue: "Access denied to this ticket"**
- **Cause**: USER role trying to access ticket they didn't create
- **Solution**: Expected behavior - users can only access their own tickets

### Debug Logging

Enable debug logging to troubleshoot JWT validation:

```bash
LOG_LEVEL=debug npm run dev
```

Look for log entries related to:
- JWT verification failures
- User lookup results
- Tenant verification
- Role mapping

## Security Considerations

1. **JWT Secret Protection**: Never commit JWT_SECRET to version control
2. **Token Expiration**: Tokens expire after 24 hours by default
3. **HTTPS Required**: Always use HTTPS in production
4. **Tenant Isolation**: All queries are automatically scoped by tenantId
5. **Role Validation**: Roles are validated at both middleware and service layers
6. **Refresh Tokens**: Use acme-auth-service's refresh endpoint for new access tokens
